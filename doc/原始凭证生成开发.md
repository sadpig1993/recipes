###原始凭证开发-凭证生成###
 - 凭证生成模块简单介绍
 - 凭证生成开发
 - 凭证生成单元测试

#####凭证生成模块简单介绍#####
zixapp是账务系统后台，凭证的导入的步骤如下：

 1. 行业线或产品线把流水文件放到账务系统的FTP服务器
 2. 账务系统后台运行的定时任务会把FTP服务器上的流水数据文件下载账务系统服务器指定的目录，同时把流水文件分隔成若干个小文件
 3. 账务系统fork若干个子进程来调用凭证生成的模块对流水文件中的流水逐条进行处理，生成账务系统的基础数据 -- 原始凭证，同时把原始凭证处理记到相应的科目表及原始凭证表。 

下面我们先了解在原始凭证处理中涉及到的zixapp模块的主要目录：  
 
 - \$HOME/workspace/zixapp/conf目录 -- 账务系统后台的配置文件目录

  - \$HOME/workspace/zixapp/conf/proc目录 -- 账务系统后台原始凭证处理配置文件目录  

  - \$HOME/workspace/zixapp/conf/svc目录 -- 账务系统后台页面调用配置文件目录

  - \$HOME/workspace/zixapp/conf/load目录 -- 账务系统后台凭证生成配置文件目录

  - \$HOME/workspace/zixapp/conf/cron目录 -- 账务系统后台定时任务配置文件目录

  - \$HOME/workspace/zixapp/conf/holi.d目录 -- 账务系统后台节假日配置文件目录

#####凭证生成开发#####
本文档以（湖南直联POS的0016）直联POS代清算收款勾兑成功凭证生成的流水文件为例，来讲述我们的load程序的开发过程。

1.更新本地的zixapp项目库，重新建立库表

- 更新本地的zixapp项目
```
cd ~/workspace/zixapp
git pull
```

- 去etc/目录下，执行zixapp的配置文件（在开发环境我们只执行profile.dev）
```
cd ~/workspace/zixapp/etc
. profile.dev
```

- 库表重新创建
```
cdsb
./tbl_crt.sh
```


2.导入新的银行协议数据

 - 和王猛确认最新的银行协议的数据，并且把数据放到指定目录，如~/bip目录

 - 在~/bip目录下，创建并执行数据导入脚本import.sh，把银行协议的数据导入到库表中。

```
cd ~/bip
touch import.sh
chmod +x import.sh
./import.sh
```

```
#！/bin/bash
# import.sh

db2 connect to $DB_NAME user $DB_USER using $DB_PASS;
db2 set current schema $DB_SCHEMA;

for file in `ls *.del`; do
tbname=${file%%.*};
db2 "import from $file of del insert into $tbname";
done;

```

3.导入最近几年的节假日数据
```
cdb
./holi_add -y 
```

4.开始0016.load的开发  

根据0016直联POS代清算收款勾兑成功凭证_20130506.docx文档和财务-业务接口管理-直联pos_v1.0.2.docx文档来确定流水文件中的字段及我们要生成的凭证的数据字段。  

生成凭证的数据来源有两种：

 - 流水文件中的数据
 - 根据银行协议计算出的数据


**流水文件中的数据**

根据上述两个文档我们得知  

period                  --会计期间            
bfee        		--银联银行成本数额        
ssn         		--交易流水编号          
lfee        		--银联品牌费数额         
cfee        		--备付金扣客户手续费收入     
c           		--客户编号            
p           	       --产品类型            
psp_c       		--分润客户编号          
cust_proto  		--分润客户协议编号        
tx_date     		--交易日期            
psp_amt     		--备付金扣客户手续费收入     
psp_lfee    		--备付金扣实时分润金额      
wlzj_type   		--往来资金类型 -- 客户手续费

上述数据项是我们根据0016直联POS代清算收款勾兑成功凭证_20130506.docx文档中的“1.1.4.1从每日直联POS代清算收款项中取值”处的取值要求，对流水文件中对应的数据项做相应的处理才得到数据（注意：日期格式取值为YYYY-MM-dd，金额部分的取值为了防止金额处理的时候出现undef，对金额做“||= 0”处理，如$bfee  ||= 0;金额为空时，做赋值为0的处理）。

**根据银行协议计算出的数据**

根据上述两个文档我们得知

bi               -- 银行接口编号             
bfj_acct_bj      -- 本金备付金银行账号          
zjbd_date_in     -- 本金备付金银行入账日期        
bfj_acct_1       -- 银行成本1备付金银行账号       
bfj_acct_2       -- 银行成本2备付金银行账号       
bfj_acct_3       -- 银行成本3备付金银行账号       
zjbd_date_out_1  -- 银行成本1备付金银行出账日期     
zjbd_date_out_2  -- 银行成本2备付金银行出账日期     
zjbd_date_out_3  -- 银行成本3备付金银行出账日期     
bfee_1           -- 银行成本1备付金扣          
bfee_2           -- 银行成本2备付金扣          
bfee_3           -- 银行成本3备付金扣          

上述数据是根据银行协议来计算获取的。

 - 根据部门编号和部门银行接口编号，系统找出对应的内部的银行接口编号
 - 根据内部银行接口编号，交易金额及matcher来计算我们的成本
  - matcher的规则：MCC*交易类型*卡类别来组成
  - 交易类型S--表示收款，N表示出款
  - 卡类别J-借记卡，X-信用卡

可到DEPT_MATCHER库表核实MATCHER是否正确，根据测试文件中数据

 - MCC：5814
 - CARD_TYPE:2信用卡

此交易是收款交易，所以0016.load用到的matcher是5814*S*X。同时根据MCC为5814，从财务-业务接口管理-直联pos_v1.0.2.docx文档中找到发卡行服务费，网络服务费，贷记卡品牌费的计算费率分别为0.55%，0.08%，0.02% 。

计算返回的值包含三部分：


1.银行接口

2.本金信息（5项）

 - 本金备付金账号

 - 本金备付金入账金额

 - 本金备付金出账金额

 - 本金备付金入账日期

 - 本金备付金出账日期


3.手续费信息（数组[12相]）

 - 手续费内扣

  - 内扣银行手续费账户

  - 内扣银行手续费入账金额

  - 内扣银行手续费出账金额

  - 内扣银行手续费出账日期

  - 内扣银行手续费入账日期


 - 手续费外扣
  - 外扣银行手续费账户
  
  - 外扣银行手续费入账金额
  
  - 外扣银行手续费出账金额
  
  - 外扣银行手续费出账日期
  
  - 外扣银行手续费入账日期


 - 财务外付
  
  - 财务外付手续费入账金额
  
  - 财务外付手续费出账金额

在确定费用的时候，我们要确定费用是内扣，外扣还是财务外付。此凭证经和业务人员确认后，此费用是内扣的。除此之外，我们还要依据测试文件中的流水数据来确定费用的主体是谁（即谁承担或收入此费用），以D打头的费用表示出款，以C打头的费用表示入款。本例子中，我们把0016.load需要用到的测试文件放在zixapp/data/pos-hn/20130501目录下，文件名为0016.src，0016.src中的测试数据为：

825430158149995|49914410|5814|2|5|1|000000079200|D00000618|201578|41|20130501131944|20130501|D00000499|D00000000016|C00000107|D00000000014

D00000618：是备付金扣客户手续费收入，D表示出款，所以该费用的主体是收款商户，表示收款商户应付618分手续费；如果数据为C000123时，由于该费用主体是收款商户，所以收款商户应收123分费用（即应付-123分）。

D00000499：是银联银行成本数额，D表示出款，所以该费用的主体是支付机构，表示支付机构应付499分银联银行成本，如果数据为C000123时，由于该费用主体是支付机构，所以支付机构应收123分成本（即应付-123分）。

D00000000016：是银联品牌费数额，D表示出款，所以该费用的主体是支付机构，表示支付机构应付16分银联品牌费成本，如果数据为C000123时，由于该费用主体是支付机构，所以支付机构应收123分成本（即应付-123分）。

C00000107：是备付金扣实时分润金额，C表示入款，所以该费用的主体是分润方，表示分润方应收107分分润金额，如果数据为D000123时，由于该费用主体是分润方，所以分润方应付123分分润金额（即应收-123分）。

D00000000014：是分润方承担品牌费，D表示出款，所以该费用的主体是支付机构，表示支付机构应付14分分润方品牌费，如果数据为C000123时，由于该费用主体是支付机构，所以支付机构应收123分成本（即应付-123分）。

#####凭证生成测试#####
1.0016.load的测试。  

为了单独测试所写0016.load是否能正确依据流水文件的数据生成原始凭证，我们可以只测流水文件中的一条记录，同时把该文件放到一个目录下面。

到zixapp/bin目录来测试0016.load生成的原始凭证的相关数据是否正确
```
cdb
./tload -t 0016 -d zixapp/data/pos-hn/20130501/0016.src
```

```
-t : 指定测试凭证
-d : 指定测试数据
```

下面是测算结果：
```
  {
    _type => "0016",
    bfee => 499,
    bfee_1 => 436,
    bfee_2 => 63,
    bfee_3 => 16,
    bfj_acct_1 => 9,
    bfj_acct_2 => 9,
    bfj_acct_3 => 9,
    bfj_acct_bj => 9,
    bi => 11,
    c => "41.825430158149995",
    cfee => 618,
    cust_proto => "5_49914410",
    lfee => 16,
    p => 5,
    period => "2013-05-01",
    psp_amt => 107,
    psp_c => "41.49914410",
    psp_lfee => 14,
    ssn => 201578,
    status => 0,
    tx_date => "2013-05-01",
    wlzj_type => 1,
    zjbd_date_in => "2013-05-02",
    zjbd_date_out_1 => "2013-05-02",
    zjbd_date_out_2 => "2013-05-02",
    zjbd_date_out_3 => "2013-05-02",
  },
```

2.验证生成的原始凭证数据是否正确，注意**在账务系统中，金额是以分为单位**

 - 交易金额：000000079200，即79200分
 - 发卡行服务费bfee_1 = 79200 x 0.55% = 435.6分
 - 网络服务费 bfee_2 = 79200 x 0.08% = 63.36分

根据银行协议及计费规则，此凭证用到的计费规则中的取整规则为四舍五入，所以

 - bfee_1 = 436分
 - bfee_2 = 63分
 - bfee = bfee_1 + bfee_2 = 499分

bfee的数据与测试文件中的数据一致


由于该手续费是内扣，所以：

 - bfj_acct_1,bfj_acct_2,bfj_acct_3应该和bfj_acct_bj账户一样，它们的值为9，9是备付金银行账户的编号，参见dim_bfj_acct库表。
 - zjbd_date_in ,zjbd_date_out_1, zjbd_date_out_2, zjbd_date_out_3分别是本金备付金银行账号入账日期，银行成本1备付金银行账户出账日期，银行成本2备付金银行账户出账日期，银行成本3备付金银行账户出账日期。

bi是11，参见bip库表。

客户编号c = 外部部门编号.客户编号（41.825430158149995）

分润方客户编号psp_c = 外部部门编号.分润方客户编号 （41.49914410）

分润客户协议编号 cust_proto = 产品类型编号_分润方客户编号 （5_49914410）

wlzj_type 往来资金类型是1，表示客户手续费，参见dim_wlzj_type表

ssn 交易流水号，参见测试文件中测试数据

lfee 银联品牌费数额，参见测试文件中测试数据

psp_lfee 分润方承担品牌费，参见测试文件中测试数据

psp_amt 分润方分润数额，参见测试文件中测试数据

tx_date 交易日期，参见测试文件中测试数据

period 会计期间，参见测试文件中测试数据

status 凭证状态 0 ，表示未处理

如果相关数据正确，那我们的0016.load的开发就结束了；如果测试结果数据不正确，请认真检查load程序和测试数据。
 