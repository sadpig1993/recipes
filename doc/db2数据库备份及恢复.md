在账务处理系统日常运维中，做好数据库的备份和恢复工作至关重要，为此特别整理此文档供开发及日常运维人员参考。本文档以数据库实例用户为db2inst，数据库名称为zdb，描述数据库的备份及恢复。

##数据库的备份##

账务系统的数据库采用日志归档模式，因此账务系统支持数据库进行在线备份。备份的步骤如下

####切换到数据库服务器实例用户####

执行
```
su - db2inst
```
命令切换到数据库服务器实例用户，然后执行
```
./dbm.sh
```命令将会看到如下命令提示：
```
使用方法： 
dbm.sh  backup                  (*备份操作)
        -d 'zdb'                (要备份的数据库名称.                                                         默认: 'zdb')
        -p '/db2back'           (备份路径.                                                                   默认： '/db2back')
        -t 'all'                (备份方式. 'all'：全备; 'inc'：增量备份.                                     默认：'inc')

    或

dbm.sh  restore                 (*恢复操作)
        -s 'zdb'                (数据库备份的数据库名.                                                       默认：'zdb')
        -p '/db2back'           (数据库备份的路径.                                                           默认：'/db2back')
        -v '20131012225521'     (*数据库备份的时间戳版本. 格式：'20131012225521')
        -t 'zdb'                (要恢复的目标数据库.                                                         默认：'zdb')
        -r 'no'                 (是否为重定向恢复.'yes' 是; 'no' 否；                                        默认：'no')
        -f 'no'                 (恢复时前滚的版本.'no' 不前滚；'2013-10-12-21.40.25.000000' 指定的时间戳.    默认：'no')
```
我们看到，应执行`./dbm.sh backup`命令进行数据库的备份，命令中的参数也很详细。

####完全备份####
比如我们现在要对`zdb`数据库做完全备份，并且备份到`/db2back/`路径，则我们可以执行如下命令：
```
./dbm.sh backup -d 'zdb' -p '/db2back' -t 'all'
```

####增量备份####
如果我们现在要对`zdb`数据库做增量备份，并且备份到`/db2back`路径，则我们可执行如下命令：
```
./dbm.sh backup -d 'zdb' -p '/db2back' -t 'inc'
```

**注意**  
完全备份 VS 增量备份  
完全备份：对库或表空间所有数据所做的备份  
增量备份：只备份前一次备份以来变化的数据  

在数据库备份成功后，我们能在`/db2back`目录看到文件名如`ZDB.0.db2inst.NODE0000.CATN0000.20131013021407.001`的数据备份文件。

**备份文件名规则**
```
ZDB             # 备份的数据库名
0               # 备份的类型： 0--全备， 3--表空间备份
db2inst         # 实例名
NODE0000        # 分区节点号（单分区固定为NODE0000）
CATN0000        # 编目节点号（单分区固定为CATN0000）
20131013021407  # 备份时间戳（备份开始的时间），以年月日时分秒表示
001             # 备份的顺序号
```

##数据库的恢复##
根据业务需求，我们将数据库的恢复分为两种： 

 1. 同库恢复
 2. 异库恢复

 

> Written with [StackEdit](http://benweet.github.io/stackedit/).