在账务处理系统日常运维中，做好数据库的备份和恢复工作至关重要，为此特别整理此文档供开发及日常运维人员参考。本文档以数据库实例用户为db2inst，数据库名称为zdb，描述数据库的备份及恢复。

##数据库的备份##

账务系统的数据库采用日志归档模式，并且我们的备份与恢复都是离线的。备份的步骤如下

####切换到数据库服务器实例用户####

执行
```
su - db2inst
```
命令切换到数据库服务器实例用户，然后执行
```
./dbm.sh
```命令将会看到如下命令提示：
```
使用方法： 
dbm.sh  backup                  (*备份操作)
        -d 'zdb'                (要备份的数据库名称.                                                         默认: 'zdb')
        -p '/db2back'           (备份路径.                                                                   默认： '/db2back')
        -t 'all'                (备份方式. 'all'：全备; 'inc'：增量备份.                                     默认：'inc')

    或

dbm.sh  restore                 (*恢复操作)
        -s 'zdb'                (数据库备份的数据库名.                                                       默认：'zdb')
        -p '/db2back'           (数据库备份的路径.                                                           默认：'/db2back')
        -v '20131012225521'     (*数据库备份的时间戳版本. 格式：'20131012225521')
        -t 'zdb'                (要恢复的目标数据库.                                                         默认：'zdb')
        -r 'no'                 (是否为重定向恢复.'yes' 是; 'no' 否；                                        默认：'no')
        -f 'no'                 (恢复时前滚的版本.'no' 不前滚；'2013-10-12-21.40.25.000000' 指定的时间戳.    默认：'no')
        -a 'no'         (自动存储路径. 'no' 不指定; '/db2auto' 指定的新的自动存储路径  默认：'no')
```
我们看到，应执行`./dbm.sh backup`命令进行数据库的备份，命令中的参数也很详细。

####完全备份####
比如我们现在要对`zdb`数据库做完全备份，并且备份到`/db2back/`路径，则我们可以执行如下命令：
```
./dbm.sh backup -d 'zdb' -p '/db2back' -t 'all'
```

####增量备份####
如果我们现在要对`zdb`数据库做增量备份，并且备份到`/db2back`路径，则我们可执行如下命令：
```
./dbm.sh backup -d 'zdb' -p '/db2back' -t 'inc'
```

**注意**  
完全备份 VS 增量备份  
完全备份：对库或表空间所有数据所做的备份  
增量备份：只备份前一次备份以来变化的数据  

在数据库备份成功后，我们能在`/db2back`目录看到文件名如`ZDB.0.db2inst.NODE0000.CATN0000.20131013021407.001`的数据备份文件。

**备份文件名规则**
```
ZDB             # 备份的数据库名
0               # 备份的类型： 0--全备， 3--表空间备份
db2inst         # 实例名
NODE0000        # 分区节点号（单分区固定为NODE0000）
CATN0000        # 编目节点号（单分区固定为CATN0000）
20131013021407  # 备份时间戳（备份开始的时间），以年月日时分秒表示
001             # 备份的顺序号
```

##数据库的恢复##
数据库恢复的命令
```
dbm.sh  restore                 (*恢复操作)
        -s 'zdb'                (数据库备份的数据库名.                                                       默认：'zdb')
        -p '/db2back'           (数据库备份的路径.                                                           默认：'/db2back')
        -v '20131012225521'     (*数据库备份的时间戳版本. 格式：'20131012225521')
        -t 'zdb'                (要恢复的目标数据库.                                                         默认：'zdb')
        -r 'no'                 (是否为重定向恢复.'yes' 是; 'no' 否；                                        默认：'no')
        -f 'no'                 (恢复时前滚的版本.'no' 不前滚；'2013-10-12-21.40.25.000000' 指定的时间戳.    默认：'no')
        -a 'no'          (自动存储路径. 'no' 不指定; '/db2auto' 指定的新的自动存储路径 默认：'no')
```

这里再阐述下具体的命令参数：

```
-s      # 指定要恢复的目标数据库的数据来源
-p      # 数据来源的路径名
-v      # 数据库备份的时间戳
-t      # 要恢复的目标数据库
-r      # 是否为重定向恢复， yes--重定向；no--非重定向
-f      # 恢复时前滚的版本，no--不前滚；指定时间戳--前滚到指定的时间戳
-a 'no' #(自动存储路径. 'no' 不指定; '/db2auto' 指定的新的自动存储路径 默认：'no')
```

根据业务需求，我们将数据库的恢复分为两种： 

 1. 同库恢复
 2. 异库恢复
 

####同库恢复####
同库恢复：恢复的数据源是来自于本数据库的备份文件。此时的数据库的恢复不用采用重定向恢复，比较简单，如要进行同库恢复，并且恢复时间戳为`20131012225521`，则执行如下的命令进行`zdb`数据库的恢复：

```
./dbm.sh restore -s 'zdb' -p '/db2back' -v '20131012225521' -t 'zdb'
```

####异库恢复####
 异库恢复：恢复的数据源来自于别的数据库的备份文件。此时目标数据库的表空间及容器可能与源数据的表空间及容器不一样，此时我们采用重定向恢复，由于表空间及其容器的不同，此时需要我们生成重定向脚本，然后来修改脚本中的表空间及其容器大小，然后再进行异库恢复。
 

 1. 执行如下恢复命令，来生成重定向恢复脚本`redirect.ddl`

 ```
 ./dbm.sh restore -s 'zdb' -p '/db2back' -v '20131012225521' -t 'zdb' -r yes -a '/db2auto'
 ```
 
 2. 修改`redirect.ddl`脚本中的表空间容器的文件及大小。将`redirect.ddl`中的表空间容器的文件及大小修改成恢复的目标数据库的表空间容器的文件及大小，并且保存修改后的脚本文件。比如，恢复的数据源的tbs\_dat表空间容器文件是`/zdb/db2tbsp/dat`，并且文件页大小是`262144`，而目标数据库的tbs\_dat表空间容器是`/db2tbsp/dat`，并且文件大小是`327680`，则需要将redirect.ddl中的tbs_dat中的表空间容器文件及大小修改成`/db2tbsp/dat`和`327680`。
 
 3. 执行`db2 -tvf redirect.ddl`命令来进行数据库的恢复。 

 4. 更改目标库的配置为原有配置（恢复前的配置）  
    如何得到目标库的原有配置呢？有两种方法，一是查看目标库的相关建表语句获得；二是通过执行`db2 get db cfg for zdb`命令来得到数据库zdb的原有配置。如为了得到主日志目录，我们可以执行`db2 get db cfg for zdb | grep -i newlogpath` 命令来得到此配置。
    
    `db2 update db cfg for zdb using newlogpath /db2plog;    #主日志目录`
    `db2 update db cfg for zdb using logfilsiz 25600;        #单日志大小`
    `db2 update db cfg for zdb using logprimary 70;          #主日志个数
    70个主日志文件` `db2 update db cfg for zdb using logsecond 150;  # 辅助日志个数`
    `辅助日志可以稍微大点，因为会自动回收` `db2 update db cfg for zdb using logarchmeth1
    "disk:/db2alog";   # 归档日志路径` `开启归档日志(支持在线备份恢复 与 前滚)` `db2 update db
    cfg for zdb using trackmod on;            # 开启增量备份模式`

 5. 做好以上配置，重启实例进行生效
 
 6. 备份目标全库  
```
# 全备份
db2 backup database zdb to /db2back;          # /db2back为目标库备份路径
```

> Written with [StackEdit](http://benweet.github.io/stackedit/).